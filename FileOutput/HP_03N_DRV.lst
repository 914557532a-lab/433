C51 COMPILER V9.01   HP_03N_DRV                                                            07/23/2024 14:43:11 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE HP_03N_DRV
OBJECT MODULE PLACED IN .\FileOutput\HP_03N_DRV.obj
COMPILER INVOKED BY: D:\software\keil\C51\BIN\C51.EXE SourceFile\HP_03N_DRV.C LARGE OMF2 OPTIMIZE(6,SPEED) BROWSE INCDIR
                    -(.\ConfigFile;.\CMT2300A) DEBUG PRINT(.\FileOutput\HP_03N_DRV.lst) TABS(2) OBJECT(.\FileOutput\HP_03N_DRV.obj)

line level    source

   1          //-----------------------------------------------------------------------------
   2          //功能说明：读取海拔高度传感器HP203N，高度，温度数据
   3          //特点说明：供电电压：1.8V~3.6V   压力量程：300mbar~1200mbar  直接读数，补偿
   4          //      高分辨率：10cm    待机电功耗： < 0.1uA  工作温度： -40~+85℃
   5          //功能码：0x0D   INT_SRC  (内部状态寄存器初值 0x00) 
   6          //      7        6         5        4         3         2         1         0
   7          //   TH_ERR   DEV_RDY   PA_RDY    T_RDY    PA_TRAV   T_TRAV    PA_WIN     T_WIN
   8          //-----------------------------------------------------------------------------
   9          #include <intrins.h>
  10          #include "ca51f_config.h"
  11          #include "ca51f2sfr.h"
  12          #include "ca51f2xsfr.h"
  13          #include "gpiodef_f2.h"
  14          #include "system.h"
  15          
  16          #include "HP_03N_DRV.H"
  17          //-----------------------------------------------------------------------------
  18          #define NOP _nop_ //重定义空操作，适应不同的编译器
  19          //-----------------------------------------------------------------------------
  20          #define IIC_SCL_CLR   P3 &= 0xEF
  21          #define IIC_SCL_SET   P3 |= 0x10
  22          
  23          #define IIC_SDA_CLR   P3 &= 0xDF
  24          #define IIC_SDA_SET   P3 |= 0x20
  25          
  26          #define IIC_SDA_I GPIO_Init(P35F,INPUT |OP_EN)//改数据方向为输入
  27          #define IIC_SDA_O GPIO_Init(P35F,OUTPUT |OP_EN)//改数据方向为输出
  28          
  29          #define Read_IIC_SDA_pin  (P35)
  30          //-----------------------------------------------------------------------------
  31          xdata unsigned char HP20X_ReadTime;
  32          
  33          xdata long  Temperature;
  34          
  35          #define PressureBufLength 8
  36          xdata unsigned char PressureIndex;
  37          xdata long  PressureBuf[PressureBufLength];
  38          xdata long  Pressure;
  39          xdata long  AvgPressure;
  40          
  41          #define AltitudeBufLength 8
  42          xdata unsigned char AltitudeIndex;
  43          xdata long  AltitudeBuf[AltitudeBufLength];
  44          xdata long  Altitude;
  45          xdata union{
  46            unsigned char Array[4];
  47            signed long Data;
  48          }AvgAltitude;
  49          //-----------------------------------------------------------------------------
  50          void Delay_10us(unsigned int Time)
  51          { do{  NOP();  NOP();
  52   2        }while(Time--);//11.0592MHz主频==3.5uS
  53   1      }
  54          //-----------------------------------------------------------------------------
C51 COMPILER V9.01   HP_03N_DRV                                                            07/23/2024 14:43:11 PAGE 2   

  55          void IIC_Start(void)
  56          { IIC_SDA_SET;
  57   1        Delay_10us(1);
  58   1        IIC_SCL_SET;
  59   1          Delay_10us(1);
  60   1        IIC_SDA_CLR;
  61   1        Delay_10us(1);
  62   1        IIC_SCL_CLR;
  63   1          Delay_10us(1);
  64   1      }
  65          //-----------------------------------------------------------------------------
  66          void IIC_Stop(void)
  67          { IIC_SCL_CLR;
  68   1        Delay_10us(1);
  69   1        IIC_SDA_CLR;
  70   1        Delay_10us(1);
  71   1        IIC_SCL_SET;
  72   1        Delay_10us(1);
  73   1        IIC_SDA_SET;
  74   1        Delay_10us(20);
  75   1      }
  76          //-----------------------------------------------------------------------------
  77          void IIC_W_ACK(void)
  78          { IIC_SDA_I;//有管脚方向的单片机
  79   1        IIC_SDA_SET;
  80   1        IIC_SCL_SET;//第9 个时钟,应答时钟
  81   1          Delay_10us(3);
  82   1        IIC_SCL_CLR;
  83   1        IIC_SDA_O;//有管脚方向的单片机
  84   1      }
  85          void IIC_R_ACK(void)
  86          { IIC_SDA_O;//有管脚方向的单片机
  87   1        IIC_SDA_CLR;
  88   1          Delay_10us(1);
  89   1        IIC_SCL_SET;
  90   1          Delay_10us(3);
  91   1        IIC_SCL_CLR;
  92   1          Delay_10us(1);
  93   1        IIC_SDA_SET;
  94   1      }
  95          //-----------------------------------------------------------------------------
  96          void IIC_NoAck(void)
  97          { IIC_SCL_CLR;
  98   1        IIC_SDA_O;//有管脚方向的单片机
  99   1        Delay_10us(1);
 100   1        IIC_SDA_SET;
 101   1        Delay_10us(3);
 102   1        IIC_SCL_SET;
 103   1        Delay_10us(1);
 104   1        IIC_SCL_CLR;
 105   1      }
 106          //-----------------------------------------------------------------------------
 107          void IIC_WriteByte (unsigned char DATA)
 108          {unsigned char Count;
 109   1      //------------------------------------------
 110   1        IIC_SDA_O;//有管脚方向的单片机
 111   1        //-------------------------------------------
 112   1        for(Count=0x00;Count<0x08;Count++)
 113   1        { if((DATA & 0x80) == 0x80)
 114   2          { IIC_SDA_SET;  }
 115   2          else
 116   2          { IIC_SDA_CLR;  }
C51 COMPILER V9.01   HP_03N_DRV                                                            07/23/2024 14:43:11 PAGE 3   

 117   2          DATA <<= 0x01;
 118   2          Delay_10us(1);
 119   2          IIC_SCL_SET;
 120   2          Delay_10us(1);
 121   2          IIC_SCL_CLR;
 122   2        }
 123   1      }
 124          
 125          //-----------------------------------------------------------------------------
 126          unsigned char IIC_ReadByte(void)
 127          {unsigned char Count,DATA=0x00;
 128   1      //------------------------------------------
 129   1        IIC_SDA_I;//有管脚方向的单片机
 130   1        //-------------------------------------------
 131   1        for(Count=0x00;Count<0x08;Count++)
 132   1        { IIC_SCL_SET;
 133   2          Delay_10us(1);
 134   2          DATA <<= 0x01;
 135   2          if(Read_IIC_SDA_pin != 0)
 136   2          { DATA = (DATA | 0x01); }
 137   2          else
 138   2          { DATA = (DATA & 0xFE); }
 139   2          IIC_SCL_CLR;
 140   2          Delay_10us(1);
 141   2        }
 142   1        //-------------------------------------------
 143   1        IIC_SDA_O;//有管脚方向的单片机
 144   1        return (DATA);
 145   1      }
 146          //===================================================================
 147          void HP20X_IIC_WriteCmd(unsigned char Cmd)
 148          { IIC_Start();
 149   1        IIC_WriteByte(HP20X_I2C_WR_ID);
 150   1        IIC_W_ACK();//等待应答信号
 151   1        IIC_WriteByte(Cmd);
 152   1        IIC_W_ACK();//等待应答信号
 153   1        IIC_Stop();
 154   1      }
 155          //===================================================================
 156          unsigned long HP20X_IIC_Read_3_Byte(void)
 157          {union{
 158   1        unsigned char Array[4];
 159   1        unsigned long Data;
 160   1      }Long;
 161   1        Long.Data = 0x00000000;//初值
 162   1        Long.Array[1] = IIC_ReadByte();
 163   1        IIC_R_ACK();//写入应答信号
 164   1        Long.Array[2] = IIC_ReadByte();
 165   1        IIC_R_ACK();//写入应答信号
 166   1        Long.Array[3] = IIC_ReadByte();
 167   1        if(Long.Data & 0x00800000)//负值，补码
 168   1        { Long.Data |= 0xFF000000;  }
 169   1        return Long.Data;
 170   1      }
 171          
 172          //===================================================================
 173          unsigned char HP20X_IIC_ReadIntReg(unsigned char Reg_ID)//读取芯片状态
 174          {unsigned char ChipState;
 175   1        HP20X_IIC_WriteCmd(HP20X_R_INT_REG |Reg_ID);
 176   1        IIC_Start();
 177   1        IIC_WriteByte(HP20X_I2C_RD_ID);
 178   1        IIC_W_ACK();//等待应答信号
C51 COMPILER V9.01   HP_03N_DRV                                                            07/23/2024 14:43:11 PAGE 4   

 179   1        ChipState = IIC_ReadByte();
 180   1        IIC_NoAck();
 181   1        IIC_Stop();
 182   1        return ChipState;
 183   1      }
 184          //===================================================================                 
 185          void HP20X_Initial(void)
 186          { HP20X_IIC_WriteCmd(HP20X_SOFT_RST);
 187   1        //-------------------------------------------
 188   1        AltitudeIndex = 0x00;
 189   1        AvgAltitude.Data = 0x00;
 190   1        Temperature = 0x00;
 191   1      }
 192          //=================================================================== 
 193          void HP20X_IIC_ReadPressure(void)
 194          { if(HP20X_IIC_ReadIntReg(INT_SRC_REG) == 0x40)
 195   1        { HP20X_IIC_WriteCmd(HP20X_READ_P);
 196   2          IIC_Start();
 197   2          IIC_WriteByte(HP20X_I2C_RD_ID);
 198   2          IIC_W_ACK();//等待应答信号
 199   2          Pressure = HP20X_IIC_Read_3_Byte();
 200   2          IIC_NoAck();
 201   2          IIC_Stop();
 202   2          //---------------计算大气压力平均值
 203   2          if(PressureIndex <PressureBufLength)
 204   2          { PressureBuf[PressureIndex++] = Pressure;  }
 205   2          else
 206   2          { AvgPressure = 0x00000000;
 207   3            for(PressureIndex =0;PressureIndex <PressureBufLength;)
 208   3            { AvgPressure += PressureBuf[PressureIndex++];  }//准备计算均值
 209   3            AvgPressure /= PressureBufLength;
 210   3            //-----------------------------------
 211   3            PressureIndex =0;
 212   3          }
 213   2        }
 214   1      }
 215          //===================================================================                          
 216          void HP20X_ReadAltitudeTemperature(void)
 217          { if(HP20X_IIC_ReadIntReg(INT_SRC_REG) == 0x40)
 218   1        { HP20X_IIC_WriteCmd(HP20X_READ_AT);
 219   2          IIC_Start();
 220   2          IIC_WriteByte(HP20X_I2C_RD_ID);
 221   2          IIC_W_ACK();//等待应答信号
 222   2          Temperature = HP20X_IIC_Read_3_Byte();
 223   2          IIC_R_ACK();
 224   2          Altitude = HP20X_IIC_Read_3_Byte();
 225   2          IIC_NoAck();
 226   2          IIC_Stop();
 227   2          //---------------计算海拔高度平均值
 228   2          if(AltitudeIndex <AltitudeBufLength)
 229   2          { AltitudeBuf[AltitudeIndex++] = Altitude;  }
 230   2          else
 231   2          { AvgAltitude.Data = 0x00000000;
 232   3            for(AltitudeIndex =0;AltitudeIndex <AltitudeBufLength;)
 233   3            { AvgAltitude.Data += AltitudeBuf[AltitudeIndex++]; }//准备计算均值
 234   3            AvgAltitude.Data /= AltitudeBufLength;
 235   3            //-----------------------------------
 236   3            if((AvgAltitude.Data & 0x80000000)== 0x80000000)//负值，补码转换
 237   3            { AvgAltitude.Data = (~AvgAltitude.Data +1) &0x00FFFFFF;  }
 238   3            //-----------------------------------
 239   3            AltitudeIndex =0;
 240   3          }
C51 COMPILER V9.01   HP_03N_DRV                                                            07/23/2024 14:43:11 PAGE 5   

 241   2        }
 242   1      }
 243          //===================================================================       
 244          void HP20X_DataProcess(void)
 245          { if(HP20X_ReadTime == 1)
 246   1        { HP20X_ReadTime++;
 247   2          HP20X_IIC_WriteCmd(HP20X_ANA_CAL);//执行内部校准
 248   2        }
 249   1        if(HP20X_ReadTime == 5)//启动转换
 250   1        { HP20X_ReadTime++;
 251   2          HP20X_IIC_WriteCmd(HP20X_CONVER_CMD |OSR_CFG);
 252   2        }
 253   1        if(HP20X_ReadTime == 8)//等待压力值转换完成
 254   1        { HP20X_ReadTime++;
 255   2          HP20X_IIC_ReadPressure();
 256   2        }
 257   1        if(HP20X_ReadTime == 9)//等待高度温度转换完成
 258   1        { HP20X_ReadTime++;
 259   2          HP20X_ReadAltitudeTemperature();
 260   2        }
 261   1      }
 262          
 263          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1075    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     87       4
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
